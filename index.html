<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>កម្មវិធីគ្រប់គ្រងបុគ្គលិក</title>
  
  <!-- 1. ផ្ទុក Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- 2. ផ្ទុក React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  
  <!-- 3. ផ្ទុក Babel (សម្រាប់បកប្រែ JSX) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    /* ធានាថាកម្មវិធីពេញអេក្រង់ និងមិនមាន scrollbar ដែលមិនចាំបាច់ */
    html, body, #root {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden; /* ការពារ scrollbar នៅលើ body */
    }
  </style>
</head>
<body>
  
  <!-- 4. ទីតាំងដែល React App នឹងបង្ហាញ -->
  <div id="root"></div>

  <!-- 5. កូដ React របស់អ្នក -->
  <script type="text/babel">
    
    // ប្រើ React Hooks ពី global React object
    const { useState, useEffect, useMemo, useCallback } = React;

    // --- API Configuration ---
    // URL ពី SheetDB API របស់អ្នក
    // យើងបន្ថែម ?sheet=បញ្ជឺឈ្មោះរួម ដើម្បីបញ្ជាក់ផ្ទាំង (Sheet) ដែលត្រូវប្រើ
    const API_URL = 'https://sheetdb.io/api/v1/t96jhv8tue3y0?sheet=បញ្ជឺឈ្មោះរួម';

    // --- Utility Functions & Components ---

    // រូបតំណាង (SVG Icons) សម្រាប់ប្រើក្នុងកម្មវិធី
    const ICONS = {
      list: (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
        </svg>
      ),
      plus: (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
        </svg>
      ),
      user: (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A1.875 1.875 0 0 1 17.624 22H6.376a1.875 1.875 0 0 1-1.875-1.882Z" />
        </svg>
      ),
      search: (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
          <path strokeLinecap="round" strokeLinejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
        </svg>
      ),
      close: (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M6 18 18 6M6 6l12 12" />
        </svg>
      ),
      arrowLeft: (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
        </svg>
      ),
      edit: (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
          <path strokeLinecap="round" strokeLinejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
        </svg>
      ),
      delete: (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
          <path strokeLinecap="round" strokeLinejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12.56 0c.342.052.682.107 1.022.166m11.538 0-1.21-1.171a2.25 2.25 0 0 0-1.631-.663H9.566a2.25 2.25 0 0 0-1.631.663L6.72 5.79m11.538 0L6.72 5.79" />
        </svg>
      ),
    };

    // Component សម្រាប់បង្ហាញពេលកំពុងទាញទិន្នន័យ
    const LoadingSpinner = () => (
      <div className="flex justify-center items-center h-full py-10">
        <div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
      </div>
    );

    // Component សម្រាប់បង្ហាញ Error
    const ErrorMessage = ({ message, onClear }) => (
      <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative my-4" role="alert">
        <strong className="font-bold">មានបញ្ហា!</strong>
        <span className="block sm:inline"> {message}</span>
        <button onClick={onClear} className="absolute top-0 bottom-0 right-0 px-4 py-3">
          <ICONS.close className="w-5 h-5" />
        </button>
      </div>
    );

    // Component សម្រាប់រូបភាព Profile
    const ProfileImage = ({ src, alt, className = "w-16 h-16" }) => {
      const [imgSrc, setImgSrc] = useState(src);
      const handleError = () => setImgSrc(null); // Set to null to render placeholder

      return (
        <div className={`${className} rounded-full flex-shrink-0 bg-gray-200 flex items-center justify-center overflow-hidden border border-gray-300`}>
          {imgSrc ? (
            <img
              src={imgSrc}
              alt={alt}
              className="w-full h-full object-cover"
              onError={handleError}
            />
          ) : (
            <ICONS.user className="w-3/5 h-3/5 text-gray-400" />
          )}
        </div>
      );
    };

    // --- Form & Data Configuration ---

    // កំណត់ Field សម្រាប់ Form បន្ថែម និងកែសម្រួល
    // key គឺជាអក្សរតំណាងជួរឈរ (Column) នៅក្នុង Google Sheet
    const FORM_FIELDS = [
      { key: 'L', label: 'គោត្តនាម និងនាម', type: 'text' },
      { key: 'M', label: 'អក្សរឡាតាំង', type: 'text' },
      { key: 'E', label: 'អត្តលេខ', type: 'text' },
      { key: 'AA', label: 'រូបថត (URL)', type: 'url' },
      { key: 'N', label: 'ភេទ', type: 'select', options: ['ប្រុស', 'ស្រី', 'ផ្សេងៗ'] },
      { key: 'O', label: 'ថ្ងៃខែឆ្នាំកំណើត', type: 'date' },
      { key: 'T', label: 'តួនាទីការងារ', type: 'text' },
      { key: 'S', label: 'ផ្នែកការងារ', type: 'text' },
      { key: 'Q', label: 'ជំនាញ', type: 'text' },
      { key: 'R', label: 'ថ្នាក់រៀន', type: 'text' },
      { key: 'C', label: 'ជំនាន់', type: 'text' },
      { key: 'D', label: 'ឆ្នាំសិក្សា', type: 'text' },
      { key: 'K', label: 'បន្ទប់', type: 'text' },
      { key: 'U', label: 'ទីកន្លែងកំណើត', type: 'text' },
      { key: 'V', label: 'Email', type: 'email' },
      { key: 'W', label: 'តេឡេក្រាម', type: 'text' },
      { key: 'Z', label: 'ថ្ងៃចូលធ្វើការ', type: 'date' },
      { key: 'B', label: 'ស្ថានភាព', type: 'text' },
      { key: 'F', label: 'វត្តមាន', type: 'text' },
      { key: 'G', label: 'ក្រុម', type: 'text' },
      { key: 'H', label: 'ROW', type: 'text' },
      { key: 'I', label: 'PC', type: 'text' },
      { key: 'AC', label: 'វេន (ចន្ទ)', type: 'text' },
      { key: 'AD', label: 'វេន (អង្គារ៍)', type: 'text' },
      { key: 'AE', label: 'វេន (ពុធ)', type: 'text' },
      { key: 'AF', label: 'វេន (ព្រហសប្បត្តិ៍)', type: 'text' },
      { key: 'AG', label: 'វេន (សុក្រ)', type: 'text' },
      { key: 'AH', label: 'វេន (សៅរ៍)', type: 'text' }, // Note: User requested AG for Sat, assuming AH
      { key: 'AI', label: 'វេន (អាទិត្យ)', type: 'text' },
    ];

    // បង្កើតទិន្នន័យដំបូងទទេសម្រាប់ Form
    const INITIAL_FORM_DATA = FORM_FIELDS.reduce((acc, field) => {
      acc[field.key] = '';
      return acc;
    }, {});

    // --- Child Components ---

    // Header (ចំណងជើង, ប្រអប់ស្វែងរក, ប៊ូតុងបន្ថែម)
    const AppHeader = ({ onSearch, onAdd }) => (
      <header className="sticky top-0 bg-white shadow-sm border-b border-gray-200 z-10 p-4">
        <div className="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-4">
          <h1 className="text-2xl font-bold text-blue-600">កម្មវិធីគ្រប់គ្រងបុគ្គលិក</h1>
          <div className="flex gap-2 w-full sm:w-auto">
            <div className="relative flex-grow">
              <input
                type="search"
                placeholder="ស្វែងរកតាមឈ្មោះ, អត្តលេខ..."
                className="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                onChange={(e) => onSearch(e.target.value)}
              />
              <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                <ICONS.search className="w-5 h-5" />
              </span>
            </div>
            <button
              onClick={onAdd}
              className="hidden sm:flex items-center gap-2 bg-blue-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-600 transition-colors"
            >
              <ICONS.plus className="w-5 h-5" />
              <span>បន្ថែមថ្មី</span>
            </button>
          </div>
        </div>
      </header>
    );

    // បញ្ជីឈ្មោះបុគ្គលិក (បង្ហាញនៅខាងឆ្វេងលើ Desktop)
    const EmployeeList = ({ employees, onSelect, selectedEmployee }) => (
      <div className="w-full md:w-1/3 lg:w-1/4 h-full overflow-y-auto border-r border-gray-200">
        {employees.length === 0 ? (
          <p className="text-gray-500 text-center p-6">មិនមានទិន្នន័យ</p>
        ) : (
          <ul className="divide-y divide-gray-200">
            {employees.map((emp, index) => (
              <li
                key={emp.id || emp.E || index} // ប្រើ 'id', 'E' (អត្តលេខ), ឬ index ជា Key
                onClick={() => onSelect(emp)}
                className={`flex items-center p-4 gap-4 cursor-pointer transition-colors ${selectedEmployee?.E === emp.E ? 'bg-blue-50' : 'hover:bg-gray-50'
                  }`}
              >
                <ProfileImage src={emp.AA} alt={emp.L} className="w-12 h-12" />
                <div className="flex-grow">
                  <p className="font-semibold text-gray-800">{emp.L || '(មិនមានឈ្មោះ)'}</p>
                  <p className="text-sm text-gray-500">{emp.T || '(មិនមានតួនាទី)'}</p>
                </div>
              </li>
            ))}
          </ul>
        )}
      </div>
    );

    // ព័ត៌មានលម្អិតរបស់បុគ្គលិក (បង្ហាញនៅខាងស្តាំលើ Desktop)
    const EmployeeDetail = ({ employee, onEdit, onDelete, onClose }) => {
      // ព័ត៌មានមូលដ្ឋាន
      const basicInfo = [
        { label: 'អក្សរឡាតាំង', value: employee.M },
        { label: 'អត្តលេខ', value: employee.E },
        { label: 'ភេទ', value: employee.N },
        { label: 'ថ្ងៃខែឆ្នាំកំណើត', value: employee.O },
        { label: 'ទីកន្លែងកំណើត', value: employee.U },
      ];
      
      // ព័ត៌មានការងារ
      const workInfo = [
        { label: 'ផ្នែកការងារ', value: employee.S },
        { label: 'តួនាទីការងារ', value: employee.T },
        { label: 'ជំនាញ', value: employee.Q },
        { label: 'ថ្នាក់រៀន', value: employee.R },
        { label: 'ជំនាន់', value: employee.C },
        { label: 'ឆ្នាំសិក្សា', value: employee.D },
        { label: 'ថ្ងៃចូលធ្វើការ', value: employee.Z },
      ];
      
      // ព័ត៌មានទំនាក់ទំនង
      const contactInfo = [
        { label: 'Email', value: employee.V, isLink: `mailto:${employee.V}` },
        { label: 'តេឡេក្រាម', value: employee.W, isLink: employee.W && employee.W.startsWith('http') ? employee.W : null },
      ];
      
      // ព័ត៌មានផ្សេងៗ
      const otherInfo = [
        { label: 'បន្ទប់', value: employee.K },
        { label: 'ក្រុម', value: employee.G },
        { label: 'PC', value: employee.I },
        { label: 'ROW', value: employee.H },
        { label: 'ស្ថានភាព', value: employee.B },
        { label: 'វត្តមាន', value: employee.F },
      ];

      // វេនធ្វើការ
      const shifts = [
        { label: 'ចន្ទ', value: employee.AC },
        { label: 'អង្គារ៍', value: employee.AD },
        { label: 'ពុធ', value: employee.AE },
        { label: 'ព្រហសប្បត្តិ៍', value: employee.AF },
        { label: 'សុក្រ', value: employee.AG },
        { label: 'សៅរ៍', value: employee.AH },
        { label: 'អាទិត្យ', value: employee.AI },
      ].filter(shift => shift.value); // បង្ហាញតែថ្ងៃណាដែលមានវេន

      // Function សម្រាប់ render section
      const renderSection = (title, data) => (
        <div className="mb-6">
          <h3 className="text-lg font-semibold text-gray-700 border-b pb-2 mb-3">{title}</h3>
          <dl className="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2">
            {data.map((item, index) => (
              item.value ? (
                <div key={item.label || index} className="sm:col-span-1 py-1">
                  <dt className="text-sm font-medium text-gray-500">{item.label}</dt>
                  <dd className="mt-1 text-sm text-gray-900">
                    {item.isLink ? (
                      <a href={item.isLink} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline">
                        {item.value}
                      </a>
                    ) : (
                      item.value
                    )}
                  </dd>
                </div>
              ) : null
            ))}
          </dl>
        </div>
      );

      return (
        <div className="w-full md:w-2/3 lg:w-3/4 h-full overflow-y-auto p-4 sm:p-6 bg-white relative">
          {/* ប៊ូតុង Back សម្រាប់ Mobile */}
          <button
            onClick={onClose}
            className="md:hidden absolute top-4 left-4 p-2 rounded-full bg-gray-100 hover:bg-gray-200"
          >
            <ICONS.arrowLeft className="w-6 h-6" />
          </button>

          {/* Header ព័ត៌មាន */}
          <div className="flex flex-col sm:flex-row items-center sm:items-start gap-6 border-b pb-6 mb-6">
            <ProfileImage src={employee.AA} alt={employee.L} className="w-24 h-24 sm:w-32 sm:h-32" />
            <div className="flex-grow text-center sm:text-left">
              <h2 className="text-2xl sm:text-3xl font-bold text-gray-900">{employee.L}</h2>
              <p className="text-lg text-blue-600">{employee.T || '(មិនមានតួនាទី)'}</p>
              <div className="flex justify-center sm:justify-start gap-3 mt-4">
                <button
                  onClick={() => onEdit(employee)}
                  className="flex items-center gap-2 bg-yellow-400 text-yellow-900 px-4 py-2 rounded-lg font-medium hover:bg-yellow-500 transition-colors"
                >
                  <ICONS.edit className="w-5 h-5" />
                  <span>កែសម្រួល</span>
                </button>
                <button
                  onClick={() => {
                    // ប្រើ Custom Modal ជំនួស confirm()
                    // ក្នុងឧទាហរណ៍នេះ ខ្ញុំនឹងប្រើ window.confirm តែអ្នកគួរតែប្តូរវា
                    if (window.confirm(`តើអ្នកប្រាកដជាចង់លុបបុគ្គលិក ${employee.L} មែនទេ?`)) {
                      onDelete(employee.E);
                    }
                  }}
                  className="flex items-center gap-2 bg-red-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-600 transition-colors"
                >
                  <ICONS.delete className="w-5 h-5" />
                  <span>លុប</span>
                </button>
              </div>
            </div>
          </div>

          {/* ព័ត៌មានលម្អិត */}
          {renderSection('ព័ត៌មានមូលដ្ឋាន', basicInfo)}
          {renderSection('ព័ត៌មានការងារ', workInfo)}
          {renderSection('ព័ត៌មានទំនាក់ទំនង', contactInfo)}
          {shifts.length > 0 && renderSection('វេនធ្វើការ', shifts)}
          {renderSection('ព័ត៌មានផ្សេងៗ', otherInfo)}
        </div>
      );
    };

    // Placeholder ពេលមិនបានជ្រើសរើសបុគ្គលិក (សម្រាប់ Desktop)
    const EmptyDetailView = () => (
      <div className="hidden md:flex w-2/3 lg:w-3/4 h-full items-center justify-center bg-gray-50">
        <div className="text-center">
          <ICONS.user className="w-24 h-24 text-gray-300 mx-auto" />
          <p className="mt-4 text-lg text-gray-500">សូមជ្រើសរើសបុគ្គលិកពីបញ្ជីខាងឆ្វេង</p>
          <p className="text-gray-400">ដើម្បីមើលព័ត៌មានលម្អិត</p>
        </div>
      </div>
    );

    // Form បែប Modal សម្រាប់ បន្ថែម និងកែសម្រួល
    const EmployeeFormModal = ({ isOpen, onClose, onSubmit, formData, setFormData, isSubmitting }) => {
      if (!isOpen) return null;

      const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData((prev) => ({ ...prev, [name]: value }));
      };

      const handleSubmit = (e) => {
        e.preventDefault();
        onSubmit();
      };
      
      // ពិនិត្យមើលថា តើនេះជា Form សម្រាប់កែសម្រួល (Edit) ឬ បន្ថែមថ្មី (Add)
      // យើងសន្មត់ថា 'id' ត្រូវបានបន្ថែមដោយ SheetDB ពេលទាញទិន្នន័យ
      const isEditing = !!formData.id; 

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-center p-4">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            {/* Modal Header */}
            <header className="flex justify-between items-center p-4 border-b">
              <h2 className="text-xl font-semibold">
                {isEditing ? 'កែសម្រួលព័ត៌មានបុគ្គលិក' : 'បន្ថែមបុគ្គលិកថ្មី'}
              </h2>
              <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100">
                <ICONS.close className="w-6 h-6" />
              </button>
            </header>

            {/* Modal Body (Form) */}
            <form onSubmit={handleSubmit} className="overflow-y-auto p-6">
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                {FORM_FIELDS.map((field) => (
                  <div key={field.key} className={field.type === 'textarea' ? 'sm:col-span-2' : ''}>
                    <label htmlFor={field.key} className="block text-sm font-medium text-gray-700 mb-1">
                      {field.label}
                    </label>
                    {field.type === 'select' ? (
                      <select
                        id={field.key}
                        name={field.key}
                        value={formData[field.key] || ''}
                        onChange={handleChange}
                        className="w-full px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      >
                        <option value="">-- ជ្រើសរើស --</option>
                        {field.options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                      </select>
                    ) : field.type === 'textarea' ? (
                      <textarea
                        id={field.key}
                        name={field.key}
                        rows="3"
                        value={formData[field.key] || ''}
                        onChange={handleChange}
                        className="w-full px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                    ) : (
                      <input
                        type={field.type || 'text'}
                        id={field.key}
                        name={field.key}
                        value={formData[field.key] || ''}
                        onChange={handleChange}
                        // ធ្វើឲ្យអត្តលេខ E មិនអាចកែបានពេល isEditing
                        disabled={isEditing && field.key === 'E'} 
                        className={`w-full px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                          isEditing && field.key === 'E' ? 'bg-gray-100 cursor-not-allowed' : ''
                        }`}
                      />
                    )}
                  </div>
                ))}
              </div>
            </form>

            {/* Modal Footer */}
            <footer className="flex justify-end items-center gap-3 p-4 border-t bg-gray-50 rounded-b-lg">
              <button
                type="button"
                onClick={onClose}
                disabled={isSubmitting}
                className="px-4 py-2 rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 disabled:opacity-50"
              >
                បោះបង់
              </button>
              <button
                type="submit"
                onClick={handleSubmit}
                disabled={isSubmitting}
                className="px-4 py-2 rounded-lg bg-blue-500 text-white font-medium hover:bg-blue-600 disabled:opacity-50 disabled:cursor-wait"
              >
                {isSubmitting ? 'កំពុងរក្សាទុក...' : 'រក្សាទុក'}
              </button>
            </footer>
          </div>
        </div>
      );
    };

    // Footer Navigation Bar (សម្រាប់តែ Mobile)
    const FooterNav = ({ view, setView, onAdd }) => (
      <nav className="md:hidden fixed bottom-0 left-0 right-0 bg-white shadow-lg border-t border-gray-200 z-10">
        <div className="flex justify-around items-center h-16">
          <button
            onClick={() => setView('list')}
            className={`flex flex-col items-center justify-center w-full h-full transition-colors ${
              view === 'list' ? 'text-blue-500' : 'text-gray-500 hover:text-blue-500'
            }`}
          >
            <ICONS.list className="w-6 h-6" />
            <span className="text-xs font-medium">បញ្ជីឈ្មោះ</span>
          </button>
          
          <button
            onClick={onAdd}
            className="flex flex-col items-center justify-center w-full h-full text-gray-500 hover:text-blue-500 transition-colors"
          >
            <div className="relative -top-4 bg-blue-500 text-white p-3 rounded-full shadow-lg">
               <ICONS.plus className="w-6 h-6" />
            </div>
            <span className="text-xs font-medium absolute bottom-2">បន្ថែមថ្មី</span>
          </button>

          <button
            onClick={() => setView('profile')} // អ្នកអាចបន្ថែមទំព័រ Profile ពេលក្រោយ
            className={`flex flex-col items-center justify-center w-full h-full transition-colors ${
              view === 'profile' ? 'text-blue-500' : 'text-gray-500 hover:text-blue-500'
            }`}
          >
            <ICONS.user className="w-6 h-6" />
            <span className="text-xs font-medium">គណនី</span>
          </button>
        </div>
      </nav>
    );


    // --- Main Application Component ---
    // ដក "export default" ចេញ ព្រោះនេះជា global function ក្នុង script
    function App() {
      // --- State ---
      const [employees, setEmployees] = useState([]); // បញ្ជីបុគ្គលិកទាំងអស់
      const [searchTerm, setSearchTerm] = useState(''); // ពាក្យសម្រាប់ស្វែងរក
      const [selectedEmployee, setSelectedEmployee] = useState(null); // បុគ្គលិកដែលបានជ្រើសរើស
      const [isLoading, setIsLoading] = useState(true); // កំពុងទាញទិន្នន័យ?
      const [error, setError] = useState(null); // សម្រាប់បង្ហាញ Error
      
      // State សម្រាប់ Mobile UI
      const [view, setView] = useState('list'); // 'list' ឬ 'detail'
      
      // State សម្រាប់ Form Modal
      const [isFormOpen, setIsFormOpen] = useState(false);
      const [isSubmitting, setIsSubmitting] = useState(false);
      const [formData, setFormData] = useState(INITIAL_FORM_DATA);
      
      // --- Data Fetching ---
      const fetchData = useCallback(async () => {
        setIsLoading(true);
        setError(null);
        try {
          const response = await fetch(API_URL);
          if (!response.ok) {
            throw new Error(`Error ${response.status}: មិនអាចទាញទិន្នន័យបាន`);
          }
          const data = await response.json();
          setEmployees(data);
        } catch (e) {
          console.error(e);
          setError(e.message);
        } finally {
          setIsLoading(false);
        }
      }, []);

      useEffect(() => {
        fetchData();
      }, [fetchData]);

      // --- Data Filtering ---
      const filteredEmployees = useMemo(() => {
        if (!searchTerm) return employees;
        const lowerCaseSearch = searchTerm.toLowerCase();
        return employees.filter(emp =>
          emp.L?.toLowerCase().includes(lowerCaseSearch) || // ស្វែងរកតាមឈ្មោះខ្មែរ (L)
          emp.M?.toLowerCase().includes(lowerCaseSearch) || // ស្វែងរកតាមឈ្មោះឡាតាំង (M)
          emp.E?.toLowerCase().includes(lowerCaseSearch)   // ស្វែងរកតាមអត្តលេខ (E)
        );
      }, [employees, searchTerm]);

      // --- Event Handlers ---

      // ពេលស្វែងរក
      const handleSearch = (term) => {
        setSearchTerm(term);
      };

      // ពេលជ្រើសរើសបុគ្គលិក
      const handleSelectEmployee = (emp) => {
        setSelectedEmployee(emp);
        setView('detail'); // ប្តូរទៅទំព័រ Detail នៅលើ Mobile
      };

      // បិទ Detail View (សម្រាប់ Mobile)
      const handleCloseDetail = () => {
        setSelectedEmployee(null);
        setView('list');
      };

      // បើក Form
      const handleOpenForm = (employeeToEdit = null) => {
        if (employeeToEdit) {
          setFormData(employeeToEdit); // បញ្ចូលទិន្នន័យចាស់សម្រាប់កែសម្រួល
        } else {
          setFormData(INITIAL_FORM_DATA); // Form ទទេសម្រាប់បន្ថែមថ្មី
        }
        setIsFormOpen(true);
      };
      
      // បិទ Form
      const handleCloseForm = () => {
        setIsFormOpen(false);
        setFormData(INITIAL_FORM_DATA); // សម្អាត Form
      };

      // ពេលបញ្ជូន Form (Submit)
      const handleSubmitForm = async () => {
        setIsSubmitting(true);
        setError(null);
        
        // ពិនិត្យថាជាការ Edit ឬ Add
        // យើងប្រើ អត្តលេខ (E) ជា unique key
        const isEditing = !!formData.id; 
        const url = isEditing
          ? `${API_URL}/E/${formData.E}` // URL សម្រាប់ PUT (Update) ដោយផ្អែកលើជួរឈរ E
          : API_URL;                      // URL សម្រាប់ POST (Create)
          
        const method = isEditing ? 'PUT' : 'POST';

        try {
          const response = await fetch(url, {
            method: method,
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
            },
            body: JSON.stringify({ data: formData }), // SheetDB រំពឹង 'data' object
          });

          if (!response.ok) {
            const errData = await response.json();
            throw new Error(errData.error || 'មិនអាចរក្សាទុកទិន្នន័យបានទេ');
          }
          
          // ជោគជ័យ
          handleCloseForm(); // បិទ Form
          await fetchData(); // ទាញទិន្នន័យថ្មី
          
          // បើជាការ Edit, update selected employee ឲ្យឃើញទិន្នន័យថ្មីភ្លាម
          if (isEditing) {
             setSelectedEmployee(formData);
          }
          
        } catch (e) {
          console.error(e);
          setError(e.message);
        } finally {
          setIsSubmitting(false);
        }
      };

      // ពេលលុប
      const handleDeleteEmployee = async (idNumber) => {
        if (!idNumber) {
          setError('មិនអាចលុបបានទេ: មិនមានអត្តលេខ (E)');
          return;
        }
        
        // បង្ហាញ Loading តូចមួយនៅលើប៊ូតុង ឬ UI... (អាចបន្ថែមពេលក្រោយ)
        setError(null);
        
        try {
          const response = await fetch(`${API_URL}/E/${idNumber}`, {
            method: 'DELETE',
          });

          if (!response.ok) {
            const errData = await response.json();
            throw new Error(errData.error || 'មិនអាចលុបទិន្នន័យបានទេ');
          }

          // ជោគជ័យ
          handleCloseDetail(); // បិទ Detail View
          await fetchData(); // ទាញទិន្នន័យថ្មី
          
        } catch (e) {
          console.error(e);
          setError(e.message);
        }
      };


      // --- Render ---
      return (
        <div className="h-screen w-screen flex flex-col font-sans bg-gray-50">
          {/* Header */}
          <AppHeader onSearch={handleSearch} onAdd={() => handleOpenForm(null)} />
          
          {/* បង្ហាញ Error */}
          {error && (
            <div className="max-w-7xl mx-auto w-full p-4">
               <ErrorMessage message={error} onClear={() => setError(null)} />
            </div>
          )}

          {/* Main Content */}
          <main className="flex-grow flex h-full overflow-hidden">
            
            {/* ---- Desktop Layout ---- */}
            
            {/* Left Panel: List (Hidden on Mobile) */}
            <div className="hidden md:block w-1/3 lg:w-1/4 flex-shrink-0 h-full">
              {isLoading ? (
                <LoadingSpinner />
              ) : (
                <EmployeeList
                  employees={filteredEmployees}
                  onSelect={handleSelectEmployee}
                  selectedEmployee={selectedEmployee}
                />
              )}
            </div>
            
            {/* Right Panel: Detail (Hidden on Mobile) */}
            <div className="hidden md:block w-2/3 lg:w-3/4 h-full">
              {selectedEmployee ? (
                <EmployeeDetail
                  employee={selectedEmployee}
                  onEdit={handleOpenForm}
                  onDelete={handleDeleteEmployee}
                  onClose={handleCloseDetail} // មិនប្រើលើ Desktop តែដាក់ឲ្យដូចគ្នា
                />
              ) : (
                <EmptyDetailView />
              )}
            </div>

            {/* ---- Mobile Layout ---- */}
            
            {/* Main View: List or Detail (Mobile Only) */}
            <div className="md:hidden w-full h-full pb-16"> {/* pb-16 សម្រាប់ទុកកន្លែងឲ្យ FooterNav */}
              {isLoading ? (
                <LoadingSpinner />
              ) : (
                <>
                  {/* បង្ហាញ List */}
                  <div className={view === 'list' ? 'block w-full h-full' : 'hidden'}>
                    <EmployeeList
                      employees={filteredEmployees}
                      onSelect={handleSelectEmployee}
                      selectedEmployee={selectedEmployee}
                    />
                  </div>
                  
                  {/* បង្ហាញ Detail */}
                  <div className={view === 'detail' && selectedEmployee ? 'block w-full h-full' : 'hidden'}>
                    {selectedEmployee && (
                      <EmployeeDetail
                        employee={selectedEmployee}
                        onEdit={handleOpenForm}
                        onDelete={handleDeleteEmployee}
                        onClose={handleCloseDetail}
                      />
                    )}
                  </div>
                  
                  {/* បង្ហាញ Profile (អាចបន្ថែមពេលក្រោយ) */}
                  <div className={view === 'profile' ? 'block w-full h-full p-6' : 'hidden'}>
                      <h2 className="text-xl font-bold">ទំព័រគណនី</h2>
                      <p className="text-gray-600">អ្នកអាចបន្ថែមព័ត៌មានគណនីនៅទីនេះ។</p>
                  </div>
                </>
              )}
            </div>

          </main>
          
          {/* Footer Navigation (Mobile Only) */}
          <FooterNav 
            view={view} 
            setView={setView} 
            onAdd={() => handleOpenForm(null)} 
          />
          
          {/* Modal Form (សម្រាប់ទាំង Desktop និង Mobile) */}
          <EmployeeFormModal
            isOpen={isFormOpen}
            onClose={handleCloseForm}
            onSubmit={handleSubmitForm}
            formData={formData}
            setFormData={setFormData}
            isSubmitting={isSubmitting}
          />
        </div>
      );
    }
    
    // --- 6. ចាប់ផ្ដើម (Mount) React App ---
    const rootElement = document.getElementById('root');
    const root = ReactDOM.createRoot(rootElement);
    root.render(<App />);
    
  </script>
</body>
</html>
